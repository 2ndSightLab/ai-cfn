AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for S3 bucket with all possible properties as parameters'

Parameters:
  # Main bucket parameters
  BucketName:
    Type: String
    Description: Name of the S3 bucket
    
  AccessControl:
    Type: String
    Description: Canned ACL to apply to the bucket
    Default: ''
    AllowedValues:
      - ''
      - Private
      - PublicRead
      - PublicReadWrite
      - AuthenticatedRead
      - LogDeliveryWrite
      - BucketOwnerRead
      - BucketOwnerFullControl
      - AwsExecRead
      
  ObjectLockEnabled:
    Type: String
    Description: Enable object lock
    Default: ''
    AllowedValues:
      - ''
      - 'true'
      - 'false'
      
  Tags:
    Type: CommaDelimitedList
    Description: List of tags (Key=Value format)
    Default: ''
    
  # AccelerateConfiguration parameters
  AccelerateConfigurationAccelerationStatus:
    Type: String
    Description: Accelerate configuration status
    Default: ''
    AllowedValues:
      - ''
      - Enabled
      - Suspended
      
  # AnalyticsConfiguration parameters
  AnalyticsConfigurationId:
    Type: String
    Description: ID for the analytics configuration
    Default: ''
    
  AnalyticsConfigurationPrefix:
    Type: String
    Description: Prefix for the analytics configuration
    Default: ''
    
  AnalyticsConfigurationTagFilters:
    Type: CommaDelimitedList
    Description: Tag filters for the analytics configuration (Key=Value format)
    Default: ''
    
  AnalyticsConfigurationStorageClassAnalysisDataExportOutputSchemaVersion:
    Type: String
    Description: Output schema version for storage class analysis data export
    Default: 'V_1'
    
  AnalyticsConfigurationStorageClassAnalysisDataExportDestinationS3BucketDestinationBucket:
    Type: String
    Description: Destination bucket for analytics data export
    Default: ''
    
  AnalyticsConfigurationStorageClassAnalysisDataExportDestinationS3BucketDestinationFormat:
    Type: String
    Description: Format for analytics data export
    Default: 'CSV'
    
  AnalyticsConfigurationStorageClassAnalysisDataExportDestinationS3BucketDestinationPrefix:
    Type: String
    Description: Prefix for analytics data export
    Default: ''
    
  # BucketEncryption parameters
  BucketEncryptionSSEAlgorithm:
    Type: String
    Description: Server-side encryption algorithm
    Default: ''
    AllowedValues:
      - ''
      - AES256
      - aws:kms
    
  BucketEncryptionKMSMasterKeyID:
    Type: String
    Description: KMS master key ID for server-side encryption
    Default: ''
    
  BucketEncryptionBucketKeyEnabled:
    Type: String
    Description: Enable S3 Bucket Key
    Default: ''
    AllowedValues:
      - ''
      - 'true'
      - 'false'
    
  # CorsConfiguration parameters
  CorsConfigurationAllowedHeaders:
    Type: CommaDelimitedList
    Description: Headers allowed in CORS requests
    Default: ''
    
  CorsConfigurationAllowedMethods:
    Type: CommaDelimitedList
    Description: HTTP methods allowed in CORS requests
    Default: ''
    
  CorsConfigurationAllowedOrigins:
    Type: CommaDelimitedList
    Description: Origins allowed in CORS requests
    Default: ''
    
  CorsConfigurationExposedHeaders:
    Type: CommaDelimitedList
    Description: Headers exposed in CORS responses
    Default: ''
    
  CorsConfigurationMaxAge:
    Type: Number
    Description: Maximum age in seconds for CORS preflight cache
    Default: 0
    
  # IntelligentTieringConfiguration parameters
  IntelligentTieringId:
    Type: String
    Description: ID for intelligent tiering configuration
    Default: ''
    
  IntelligentTieringPrefix:
    Type: String
    Description: Prefix for intelligent tiering configuration
    Default: ''
    
  IntelligentTieringTagFilters:
    Type: CommaDelimitedList
    Description: Tag filters for intelligent tiering (Key=Value format)
    Default: ''
    
  IntelligentTieringStatus:
    Type: String
    Description: Status for intelligent tiering
    Default: 'Enabled'
    AllowedValues:
      - 'Enabled'
      - 'Disabled'
    
  IntelligentTieringTierings:
    Type: CommaDelimitedList
    Description: List of tiering configurations
    Default: 'ARCHIVE_ACCESS=90,DEEP_ARCHIVE_ACCESS=180'
    
  # InventoryConfiguration parameters
  InventoryId:
    Type: String
    Description: ID for inventory configuration
    Default: ''
    
  InventoryEnabled:
    Type: String
    Description: Enable inventory configuration
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    
  InventoryIncludedObjectVersions:
    Type: String
    Description: Object versions to include in inventory
    Default: 'All'
    AllowedValues:
      - 'All'
      - 'Current'
    
  InventoryScheduleFrequency:
    Type: String
    Description: Frequency of inventory generation
    Default: 'Weekly'
    AllowedValues:
      - 'Daily'
      - 'Weekly'
    
  InventoryDestinationBucketArn:
    Type: String
    Description: ARN of the destination bucket for inventory
    Default: ''
    
  InventoryDestinationFormat:
    Type: String
    Description: Format of inventory report
    Default: 'CSV'
    AllowedValues:
      - 'CSV'
      - 'ORC'
      - 'Parquet'
    
  InventoryDestinationPrefix:
    Type: String
    Description: Prefix for inventory report
    Default: ''
    
  InventoryOptionalFields:
    Type: CommaDelimitedList
    Description: Optional fields to include in inventory
    Default: 'Size,LastModifiedDate,StorageClass,ETag,IsMultipartUploaded,ReplicationStatus,EncryptionStatus,ObjectLockRetainUntilDate,ObjectLockMode,ObjectLockLegalHoldStatus,IntelligentTieringAccessTier,BucketKeyStatus,ChecksumAlgorithm'
    
  # LifecycleConfiguration parameters
  LifecycleRuleId:
    Type: String
    Description: ID for lifecycle rule
    Default: ''
    
  LifecycleRuleStatus:
    Type: String
    Description: Status of lifecycle rule
    Default: 'Enabled'
    AllowedValues:
      - 'Enabled'
      - 'Disabled'
    
  LifecycleRulePrefix:
    Type: String
    Description: Prefix for lifecycle rule
    Default: ''
    
  LifecycleRuleTagFilters:
    Type: CommaDelimitedList
    Description: Tag filters for lifecycle rule (Key=Value format)
    Default: ''
    
  LifecycleRuleExpirationDays:
    Type: Number
    Description: Days after which objects expire
    Default: 0
    
  LifecycleRuleNoncurrentVersionExpirationDays:
    Type: Number
    Description: Days after which noncurrent versions expire
    Default: 0
    
  # LoggingConfiguration parameters
  LoggingDestinationBucketName:
    Type: String
    Description: Destination bucket for access logs
    Default: ''
    
  LoggingLogFilePrefix:
    Type: String
    Description: Prefix for access logs
    Default: ''
    
  # MetricsConfiguration parameters
  MetricsId:
    Type: String
    Description: ID for metrics configuration
    Default: ''
    
  MetricsPrefix:
    Type: String
    Description: Prefix for metrics configuration
    Default: ''
    
  MetricsTagFilters:
    Type: CommaDelimitedList
    Description: Tag filters for metrics configuration (Key=Value format)
    Default: ''
    
  # NotificationConfiguration parameters
  NotificationLambdaEvent:
    Type: String
    Description: Event for Lambda notification
    Default: ''
    
  NotificationLambdaFunction:
    Type: String
    Description: ARN of Lambda function for notification
    Default: ''
    
  NotificationLambdaFilterPrefix:
    Type: String
    Description: Prefix filter for Lambda notification
    Default: ''
    
  NotificationLambdaFilterSuffix:
    Type: String
    Description: Suffix filter for Lambda notification
    Default: ''
    
  NotificationQueueEvent:
    Type: String
    Description: Event for queue notification
    Default: ''
    
  NotificationQueueQueue:
    Type: String
    Description: ARN of queue for notification
    Default: ''
    
  NotificationQueueFilterPrefix:
    Type: String
    Description: Prefix filter for queue notification
    Default: ''
    
  NotificationQueueFilterSuffix:
    Type: String
    Description: Suffix filter for queue notification
    Default: ''
    
  NotificationTopicEvent:
    Type: String
    Description: Event for topic notification
    Default: ''
    
  NotificationTopicTopic:
    Type: String
    Description: ARN of topic for notification
    Default: ''
    
  NotificationTopicFilterPrefix:
    Type: String
    Description: Prefix filter for topic notification
    Default: ''
    
  NotificationTopicFilterSuffix:
    Type: String
    Description: Suffix filter for topic notification
    Default: ''
    
  # ObjectLockConfiguration parameters
  ObjectLockDefaultRetentionMode:
    Type: String
    Description: Default retention mode for object lock
    Default: ''
    AllowedValues:
      - ''
      - GOVERNANCE
      - COMPLIANCE
    
  ObjectLockDefaultRetentionDays:
    Type: Number
    Description: Default retention period in days for object lock
    Default: 0
    
  ObjectLockDefaultRetentionYears:
    Type: Number
    Description: Default retention period in years for object lock
    Default: 0
    
  # OwnershipControls parameters
  OwnershipControlsRule:
    Type: String
    Description: Ownership controls rule
    Default: ''
    AllowedValues:
      - ''
      - BucketOwnerPreferred
      - ObjectWriter
      - BucketOwnerEnforced
    
  # ReplicationConfiguration parameters
  ReplicationRole:
    Type: String
    Description: IAM role ARN for replication
    Default: ''
    
  ReplicationRuleId:
    Type: String
    Description: ID for replication rule
    Default: ''
    
  ReplicationRuleStatus:
    Type: String
    Description: Status of replication rule
    Default: 'Enabled'
    AllowedValues:
      - 'Enabled'
      - 'Disabled'
    
  ReplicationRulePriority:
    Type: Number
    Description: Priority of replication rule
    Default: 0
    
  ReplicationRulePrefix:
    Type: String
    Description: Prefix for replication rule
    Default: ''
    
  ReplicationRuleDestinationBucket:
    Type: String
    Description: ARN of destination bucket for replication
    Default: ''
    
  ReplicationRuleDestinationStorageClass:
    Type: String
    Description: Storage class for replicated objects
    Default: ''
    
  # VersioningConfiguration parameters
  VersioningStatus:
    Type: String
    Description: Versioning state of the bucket
    Default: ''
    AllowedValues:
      - ''
      - Enabled
      - Suspended
    
  # WebsiteConfiguration parameters
  WebsiteIndexDocument:
    Type: String
    Description: Index document for website configuration
    Default: ''
    
  WebsiteErrorDocument:
    Type: String
    Description: Error document for website configuration
    Default: ''
    
  WebsiteRedirectAllRequestsToHostName:
    Type: String
    Description: Host name for redirect all requests
    Default: ''
    
  WebsiteRedirectAllRequestsToProtocol:
    Type: String
    Description: Protocol for redirect all requests
    Default: ''
    AllowedValues:
      - ''
      - http
      - https
    
  WebsiteRoutingRules:
    Type: CommaDelimitedList
    Description: Routing rules for website configuration
    Default: ''

Conditions:
  HasBucketName: !Not [!Equals [!Ref BucketName, '']]
  HasAccessControl: !Not [!Equals [!Ref AccessControl, '']]
  HasObjectLockEnabled: !Not [!Equals [!Ref ObjectLockEnabled, '']]
  HasTags: !Not [!Equals [!Select [0, !Ref Tags], '']]
  
  # Child object conditions
  HasAcceleateConfiguration: !Not [!Equals [!Select [0, !Ref AccelerateConfiguration], '']]
  HasAnalyticsConfiguration: !Not [!Equals [!Select [0, !Ref AnalyticsConfiguration], '']]
  HasAnalyticsConfigurationPrefix: !Not [!Equals [!Select [0, !Ref AnalyticsConfigurationPrefix], '']]
  HasAnalyticsConfigurationTagFilters: !Not [!Equals [!Select [0, !Ref AnalyticsConfigurationTagFilters], '']]
  
  # BucketEncryption conditions
  HasBucketEncryptionSSEAlgorithm: !Not [!Equals [!Select [0, !Ref BucketEncryptionSSEAlgorithm], '']]
  HasBucketEncryptionKMS: !And 
    - !Not [!Equals [!Select [0, !Ref BucketEncryptionSSEAlgorithm], '']]
    - !Equals [!Select [0, !Ref BucketEncryptionSSEAlgorithm], 'aws:kms']
  HasBucketEncryptionKMSKey: !Not [!Equals [!Select [0, !Ref BucketEncryptionKMSMasterKeyID], '']]
  HasBucketKeyEnabled: !Not [!Equals [!Select [0, !Ref BucketEncryptionBucketKeyEnabled], '']]
  
  # CORS conditions
  HasCorsConfiguration: !Not [!Equals [!Select [0, !Ref CorsConfiguration], '']]
  HasCorsAllowedHeaders: !Not [!Equals [!Select [0, !Ref CorsConfigurationAllowedHeaders], '']]
  HasCorsAllowedMethods: !Not [!Equals [!Select [0, !Ref CorsConfigurationAllowedMethods], '']]
  HasCorsAllowedOrigins: !Not [!Equals [!Select [0, !Ref CorsConfigurationAllowedOrigins], '']]
  HasCorsExposedHeaders: !Not [!Equals [!Select [0, !Ref CorsConfigurationExposedHeaders], '']]
  HasCorsMaxAge: !Not [!Equals [!Select [0, !Ref CorsConfigurationMaxAge], '']]
  
  # IntelligentTiering conditions
  HasIntelligentTieringConfiguration: !Not [!Equals [!Select [0, !Ref IntelligentTieringConfiguration], '']]
  HasIntelligentTieringPrefix: !Not [!Equals [!Select [0, !Ref IntelligentTieringConfigurationPrefix], '']]
  HasIntelligentTieringTagFilters: !Not [!Equals [!Select [0, !Ref IntelligentTieringConfigurationTagFilters], '']]
  
  # Inventory conditions
  HasInventoryConfiguration: !Not [!Equals [!Select [0, !Ref InventoryConfiguration], '']]
  HasInventoryPrefix: !Not [!Equals [!Select [0, !Ref InventoryConfigurationPrefix], '']]
  
  # Lifecycle conditions
  HasLifecycleConfiguration: !Not [!Equals [!Select [0, !Ref LifecycleConfiguration], '']]
  HasLifecyclePrefix: !Not [!Equals [!Select [0, !Ref LifecycleConfigurationPrefix], '']]
  
  # Logging conditions
  HasLoggingConfiguration: !Not [!Equals [!Select [0, !Ref LoggingConfiguration], '']]
  
  # Metrics conditions
  HasMetricsConfiguration: !Not [!Equals [!Select [0, !Ref MetricsConfiguration], '']]
  
  # Notification conditions
  HasLambdaNotification: !And
    - !Not [!Equals [!Select [0, !Ref NotificationLambdaEvent], '']]
    - !Not [!Equals [!Select [0, !Ref NotificationLambdaFunction], '']]
  HasQueueNotification: !And
    - !Not [!Equals [!Select [0, !Ref NotificationQueueEvent], '']]
    - !Not [!Equals [!Select [0, !Ref NotificationQueueQueue], '']]
  HasTopicNotification: !Not [!Equals [!Select [0, !Ref NotificationTopicEvent], '']]
  
  # ObjectLock conditions
  HasObjectLockConfiguration: !Not [!Equals [!Select [0, !Ref ObjectLockConfiguration], '']]
  
  # OwnershipControls conditions
  HasOwnershipControls: !Not [!Equals [!Select [0, !Ref OwnershipControls], '']]
  
  # Replication conditions
  HasReplicationConfiguration: !Not [!Equals [!Select [0, !Ref ReplicationConfiguration], '']]
  
  # Versioning conditions
  HasVersioningConfiguration: !Not [!Equals [!Select [0, !Ref VersioningConfiguration], '']]
  
  # Website conditions
  HasWebsiteIndexDocument: !Not [!Equals [!Select [0, !Ref WebsiteIndexDocument], '']]
  HasWebsiteErrorDocument: !Not [!Equals [!Select [0, !Ref WebsiteErrorDocument], '']]
  HasWebsiteRedirectAllRequestsTo: !Not [!Equals [!Select [0, !Ref WebsiteRedirectAllRequestsToHostName], '']]
  HasWebsiteRedirectProtocol: !Not [!Equals [!Select [0, !Ref WebsiteRedirectAllRequestsToProtocol], '']]
  HasWebsiteRoutingRules: !Not [!Equals [!Select [0, !Ref WebsiteRoutingRules], '']]
  HasWebsiteConfiguration: !Or
    - !Condition HasWebsiteIndexDocument
    - !Condition HasWebsiteRedirectAllRequestsTo

Resources:
  S3Bucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !If [HasBucketName, !Ref BucketName, !Ref 'AWS::NoValue']
      AccessControl: !If [HasAccessControl, !Ref AccessControl, !Ref 'AWS::NoValue']
      ObjectLockEnabled: !If [HasObjectLockEnabled, !Ref ObjectLockEnabled, !Ref 'AWS::NoValue']
      Tags: !If [HasTags, !Join [',', !Ref Tags], !Ref 'AWS::NoValue']
      
      # PublicAccessBlockConfiguration - set to true by default
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      
      # AccelerateConfiguration
      AccelerateConfiguration: !If
        - HasAcceleateConfiguration
        - AccelerationStatus: !Ref !Select [0, !Ref AccelerateConfiguration]
        - !Ref 'AWS::NoValue'
      
      # AnalyticsConfiguration
      AnalyticsConfiguration: !If
        - HasAnalyticsConfiguration
        - - Id: !Ref !Select [0, !Ref AnalyticsConfiguration]
            Prefix: !If [HasAnalyticsConfigurationPrefix, !Ref !Select [0, !Ref AnalyticsConfigurationPrefix], !Ref 'AWS::NoValue']
            TagFilters: !If 
              - HasAnalyticsConfigurationTagFilters
              - !Join [',', !Ref !Select [0, !Ref AnalyticsConfigurationTagFilters]]
              - !Ref 'AWS::NoValue'
        - !Ref 'AWS::NoValue'
      
      # BucketEncryption
      BucketEncryption: !If
        - HasBucketEncryptionSSEAlgorithm
        - ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: !If [HasBucketEncryptionKMS, 'aws:kms', !Ref !Select [0, !Ref BucketEncryptionSSEAlgorithm]]
              KMSMasterKeyID: !If [HasBucketEncryptionKMSKey, !Ref !Select [0, !Ref BucketEncryptionKMSMasterKeyID], !Ref 'AWS::NoValue']
            BucketKeyEnabled: !If [HasBucketKeyEnabled, !Ref !Select [0, !Ref BucketEncryptionBucketKeyEnabled], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # CorsConfiguration
      CorsConfiguration: !If
        - HasCorsConfiguration
        - CorsRules:
          - AllowedHeaders: !If [HasCorsAllowedHeaders, !Join [',', !Ref !Select [0, !Ref CorsConfigurationAllowedHeaders]], !Ref 'AWS::NoValue']
          - AllowedMethods: !If [HasCorsAllowedMethods, !Join [',', !Ref !Select [0, !Ref CorsConfigurationAllowedMethods]], !Ref 'AWS::NoValue']
          - AllowedOrigins: !If [HasCorsAllowedOrigins, !Join [',', !Ref !Select [0, !Ref CorsConfigurationAllowedOrigins]], !Ref 'AWS::NoValue']
          - ExposedHeaders: !If [HasCorsExposedHeaders, !Join [',', !Ref !Select [0, !Ref CorsConfigurationExposedHeaders]], !Ref 'AWS::NoValue']
          - MaxAge: !If [HasCorsMaxAge, !Ref !Select [0, !Ref CorsConfigurationMaxAge], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # IntelligentTieringConfiguration
      IntelligentTieringConfiguration: !If
        - HasIntelligentTieringConfiguration
        - - Id: !Ref !Select [0, !Ref IntelligentTieringConfiguration]
            Status: !Ref !Select [0, !Ref IntelligentTieringConfiguration]
            Prefix: !If [HasIntelligentTieringPrefix, !Ref !Select [0, !Ref IntelligentTieringConfigurationPrefix], !Ref 'AWS::NoValue']
            TagFilters: !If 
              - HasIntelligentTieringTagFilters
              - !Join [',', !Ref !Select [0, !Ref IntelligentTieringConfigurationTagFilters]]
              - !Ref 'AWS::NoValue'
        - !Ref 'AWS::NoValue'
      
      # InventoryConfiguration
      InventoryConfiguration: !If
        - HasInventoryConfiguration
        - - Id: !Ref !Select [0, !Ref InventoryConfiguration]
            Enabled: !Ref !Select [0, !Ref InventoryConfiguration]
            Prefix: !If [HasInventoryPrefix, !Ref !Select [0, !Ref InventoryConfigurationPrefix], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # LifecycleConfiguration
      LifecycleConfiguration: !If
        - HasLifecycleConfiguration
        - Rules:
          - Id: !Ref !Select [0, !Ref LifecycleConfiguration]
            Status: !Ref !Select [0, !Ref LifecycleConfiguration]
            Prefix: !If [HasLifecyclePrefix, !Ref !Select [0, !Ref LifecycleConfigurationPrefix], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # LoggingConfiguration
      LoggingConfiguration: !If
        - HasLoggingConfiguration
        - LoggingRules:
          - Destination: !Ref !Select [0, !Ref LoggingConfiguration]
          LogFilePrefix: !If [HasLoggingConfiguration, !Ref !Select [0, !Ref LoggingConfigurationLogFilePrefix], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # MetricsConfiguration
      MetricsConfiguration: !If
        - HasMetricsConfiguration
        - - Id: !Ref !Select [0, !Ref MetricsConfiguration]
            Prefix: !If [HasMetricsConfigurationPrefix, !Ref !Select [0, !Ref MetricsConfigurationPrefix], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # NotificationConfiguration
      NotificationConfiguration: !If
        - HasNotificationConfiguration
        - LambdaConfigurations: !If
            - HasLambdaNotification
            - - Event: !Ref !Select [0, !Ref NotificationLambdaEvent]
                Function: !Ref !Select [0, !Ref NotificationLambdaFunction]
            - !Ref 'AWS::NoValue'
          QueueConfigurations: !If
            - HasQueueNotification
            - - Event: !Ref !Select [0, !Ref NotificationQueueEvent]
                Queue: !Ref !Select [0, !Ref NotificationQueueQueue]
            - !Ref 'AWS::NoValue'
          TopicConfigurations: !If
            - HasTopicNotification
            - - Event: !Ref !Select [0, !Ref NotificationTopicEvent]
                Topic: !Ref !Select [0, !Ref NotificationTopicTopic]
            - !Ref 'AWS::NoValue'
        - !Ref 'AWS::NoValue'
      
      # ObjectLockConfiguration
      ObjectLockConfiguration: !If
        - HasObjectLockConfiguration
        - ObjectLockEnabled: 'Enabled'
          Rule: !If
            - HasObjectLockConfiguration
            - DefaultRetention:
                Mode: !Ref !Select [0, !Ref ObjectLockConfigurationRetentionMode]
                Days: !If [HasObjectLockConfigurationRetentionDays, !Ref !Select [0, !Ref ObjectLockConfigurationRetentionDays], !Ref 'AWS::NoValue']
                Years: !If [HasObjectLockConfigurationRetentionYears, !Ref !Select [0, !Ref ObjectLockConfigurationRetentionYears], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # OwnershipControls
      OwnershipControls: !If
        - HasOwnershipControls
        - Rules:
          - ObjectOwnership: !Ref !Select [0, !Ref OwnershipControls]
        - !Ref 'AWS::NoValue'
      
      # ReplicationConfiguration
      ReplicationConfiguration: !If
        - HasReplicationConfiguration
        - Role: !Ref !Select [0, !Ref ReplicationConfigurationRole]
        - Rules:
          - Id: !Ref !Select [0, !Ref ReplicationConfigurationRuleId]
            Status: !Ref !Select [0, !Ref ReplicationConfigurationRuleStatus]
            Prefix: !If [HasReplicationConfigurationPrefix, !Ref !Select [0, !Ref ReplicationConfigurationPrefix], !Ref 'AWS::NoValue']
            Destination:
              Bucket: !If [HasReplicationConfigurationDestination, !Ref !Select [0, !Ref ReplicationConfigurationDestination], !Ref 'AWS::NoValue']
              StorageClass: !If [HasReplicationConfigurationStorageClass, !Ref !Select [0, !Ref ReplicationConfigurationStorageClass], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      
      # VersioningConfiguration
      VersioningConfiguration: !If
        - HasVersioningConfiguration
        - Status: !Ref !Select [0, !Ref VersioningConfigurationStatus]
        - !Ref 'AWS::NoValue'
      
      # WebsiteConfiguration
      WebsiteConfiguration: !If
        - HasWebsiteConfiguration
        - !If
          - HasWebsiteRedirectAllRequestsTo
          - RedirectAllRequestsTo:
              HostName: !Ref !Select [0, !Ref WebsiteRedirectAllRequestsToHostName]
              Protocol: !If [HasWebsiteRedirectProtocol, !Ref !Select [0, !Ref WebsiteRedirectAllRequestsToProtocol], !Ref 'AWS::NoValue']
          - !If
            - HasWebsiteIndexDocument
            - IndexDocument: !Ref !Select [0, !Ref WebsiteIndexDocument]
              ErrorDocument: !If [HasWebsiteErrorDocument, !Ref !Select [0, !Ref WebsiteErrorDocument], !Ref 'AWS::NoValue']
              RoutingRules: !If [HasWebsiteRoutingRules, !Join [',', !Ref !Select [0, !Ref WebsiteRoutingRules]], !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'

Outputs:
  BucketName:
    Description: Name of the created S3 bucket
    Value: !Ref S3Bucket
    Export:
      Name: !Sub '\${AWS::StackName}-S3AccessLogsBucketName'
  
  BucketARN:
    Description: ARN of the created S3 bucket
    Value: !GetAtt S3Bucket.Arn
    Export:
      Name: !Sub '\${AWS::StackName}-S3AccessLogsBucketArn'
  
  BucketDomainName:
    Description: Domain name of the created S3 bucket
    Value: !GetAtt S3Bucket.DomainName
    Export:
      Name: !Sub '\${AWS::StackName}-S3AccessLogsBucketDomainName'
  
  BucketRegionalDomainName:
    Description: Regional domain name of the created S3 bucket
    Value: !GetAtt S3Bucket.RegionalDomainName
    Export:
      Name: !Sub '\${AWS::StackName}-S3AccessLogsBucketRegionalDomainName'
  
  BucketWebsiteURL:
    Description: Website URL of the created S3 bucket (if website configuration is enabled)
    Value: !If [HasWebsiteConfiguration, !GetAtt S3Bucket.WebsiteURL, !Ref 'AWS::NoValue']
    Condition: HasWebsiteConfiguration
    Export:
      Name: !Sub '\${AWS::StackName}-S3AccessLogsBucketWebsiteURL'
      
