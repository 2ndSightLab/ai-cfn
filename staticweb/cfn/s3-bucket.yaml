
AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for S3 bucket with all possible properties as parameters'

Parameters:
  BucketName:
    Type: String
    Description: Name of the S3 bucket
    Default: 'my-s3-bucket'
    
  AccessControl:
    Type: String
    Description: Canned ACL to apply to the bucket
    Default: 'Private'
    AllowedValues:
      - ''
      - Private
      - PublicRead
      - PublicReadWrite
      - AuthenticatedRead
      - LogDeliveryWrite
      - BucketOwnerRead
      - BucketOwnerFullControl
      - AwsExecRead
      
  ObjectLockEnabled:
    Type: String
    Description: Enable object lock
    Default: 'false'
    AllowedValues:
      - ''
      - 'true'
      - 'false'
      
  Tags:
    Type: CommaDelimitedList
    Description: List of tags (Key=Value format)
    Default: ''
    
  # ... [other parameters] ...

Conditions:
  HasBucketName: !Not [!Equals [!Ref BucketName, '']]
  HasAccessControl: !Not [!Equals [!Ref AccessControl, '']]
  HasObjectLockEnabled: !Not [!Equals [!Ref ObjectLockEnabled, '']]
  HasTags: !Not [!Equals [!Select [0, !Ref Tags], '']]
  
  # Child object conditions
  HasAccelerateConfiguration: !Not [!Equals [!Ref AccelerateConfigurationAccelerationStatus, '']]
  
  HasAnalyticsConfiguration: !Not [!Equals [!Ref AnalyticsConfigurationId, '']]
  HasAnalyticsConfigurationPrefix: !Not [!Equals [!Ref AnalyticsConfigurationPrefix, '']]
  HasAnalyticsConfigurationTagFilters: !Not [!Equals [!Select [0, !Ref AnalyticsConfigurationTagFilters], '']]
  
  # BucketEncryption conditions
  HasBucketEncryption: !Not [!Equals [!Ref BucketEncryptionSSEAlgorithm, '']]
  HasBucketEncryptionKMS: !And 
    - !Not [!Equals [!Ref BucketEncryptionSSEAlgorithm, '']]
    - !Equals [!Ref BucketEncryptionSSEAlgorithm, 'aws:kms']
  HasBucketEncryptionKMSKey: !And
    - !Not [!Equals [!Ref BucketEncryptionKMSMasterKeyID, '']]
    - !Equals [!Ref BucketEncryptionSSEAlgorithm, 'aws:kms']
  HasBucketKeyEnabled: !Not [!Equals [!Ref BucketEncryptionBucketKeyEnabled, '']]
  
  # CORS conditions
  HasCorsConfiguration: !Not [!Equals [!Select [0, !Ref CorsConfigurationAllowedMethods], '']]
  HasCorsAllowedHeaders: !Not [!Equals [!Select [0, !Ref CorsConfigurationAllowedHeaders], '']]
  HasCorsAllowedOrigins: !Not [!Equals [!Select [0, !Ref CorsConfigurationAllowedOrigins], '']]
  HasCorsExposedHeaders: !Not [!Equals [!Select [0, !Ref CorsConfigurationExposedHeaders], '']]
  HasCorsMaxAge: !Not [!Equals [!Ref CorsConfigurationMaxAge, 0]]
  
  # IntelligentTiering conditions
  HasIntelligentTiering: !Not [!Equals [!Ref IntelligentTieringId, '']]
  HasIntelligentTieringPrefix: !Not [!Equals [!Ref IntelligentTieringPrefix, '']]
  HasIntelligentTieringTagFilters: !Not [!Equals [!Select [0, !Ref IntelligentTieringTagFilters], '']]
  
  # Inventory conditions
  HasInventory: !Not [!Equals [!Ref InventoryId, '']]
  HasInventoryDestination: !Not [!Equals [!Ref InventoryDestinationBucketArn, '']]
  HasInventoryPrefix: !Not [!Equals [!Ref InventoryDestinationPrefix, '']]
  
  # Lifecycle conditions
  HasLifecycle: !Not [!Equals [!Ref LifecycleRuleId, '']]
  HasLifecyclePrefix: !Not [!Equals [!Ref LifecycleRulePrefix, '']]
  HasLifecycleTagFilters: !Not [!Equals [!Select [0, !Ref LifecycleRuleTagFilters], '']]
  HasLifecycleExpiration: !Not [!Equals [!Ref LifecycleRuleExpirationDays, 0]]
  HasLifecycleNoncurrentVersionExpiration: !Not [!Equals [!Ref LifecycleRuleNoncurrentVersionExpirationDays, 0]]
  
  # Logging conditions
  HasLogging: !Not [!Equals [!Ref LoggingDestinationBucketName, '']]
  HasLoggingPrefix: !Not [!Equals [!Ref LoggingLogFilePrefix, '']]
  
  # Metrics conditions
  HasMetrics: !Not [!Equals [!Ref MetricsId, '']]
  HasMetricsPrefix: !Not [!Equals [!Ref MetricsPrefix, '']]
  HasMetricsTagFilters: !Not [!Equals [!Select [0, !Ref MetricsTagFilters], '']]
  
  # Notification conditions
  HasLambdaNotification: !And
    - !Not [!Equals [!Ref NotificationLambdaEvent, '']]
    - !Not [!Equals [!Ref NotificationLambdaFunction, '']]
  HasLambdaFilterPrefix: !Not [!Equals [!Ref NotificationLambdaFilterPrefix, '']]
  HasLambdaFilterSuffix: !Not [!Equals [!Ref NotificationLambdaFilterSuffix, '']]
  
  HasQueueNotification: !And
    - !Not [!Equals [!Ref NotificationQueueEvent, '']]
    - !Not [!Equals [!Ref NotificationQueueQueue, '']]
  HasQueueFilterPrefix: !Not [!Equals [!Ref NotificationQueueFilterPrefix, '']]
  HasQueueFilterSuffix: !Not [!Equals [!Ref NotificationQueueFilterSuffix, '']]
  
  HasTopicNotification: !And
    - !Not [!Equals [!Ref NotificationTopicEvent, '']]
    - !Not [!Equals [!Ref NotificationTopicTopic, '']]
  HasTopicFilterPrefix: !Not [!Equals [!Ref NotificationTopicFilterPrefix, '']]
  HasTopicFilterSuffix: !Not [!Equals [!Ref NotificationTopicFilterSuffix, '']]
  
  HasNotificationConfiguration: !Or
    - !Condition HasLambdaNotification
    - !Condition HasQueueNotification
    - !Condition HasTopicNotification
  
  # ObjectLock conditions
  HasObjectLockConfiguration: !Or
    - !Not [!Equals [!Ref ObjectLockDefaultRetentionMode, '']]
    - !Not [!Equals [!Ref ObjectLockDefaultRetentionDays, 0]]
    - !Not [!Equals [!Ref ObjectLockDefaultRetentionYears, 0]]
  HasObjectLockRetentionDays: !Not [!Equals [!Ref ObjectLockDefaultRetentionDays, 0]]
  HasObjectLockRetentionYears: !Not [!Equals [!Ref ObjectLockDefaultRetentionYears, 0]]
  
  # OwnershipControls conditions
  HasOwnershipControls: !Not [!Equals [!Ref OwnershipControlsRule, '']]
  
  # Replication conditions
  HasReplication: !And
    - !Not [!Equals [!Ref ReplicationRole, '']]
    - !Not [!Equals [!Ref ReplicationRuleId, '']]
    - !Not [!Equals [!Ref ReplicationRuleDestinationBucket, '']]
  HasReplicationPrefix: !Not [!Equals [!Ref ReplicationRulePrefix, '']]
  HasReplicationStorageClass: !Not [!Equals [!Ref ReplicationRuleDestinationStorageClass, '']]
  
  # Versioning conditions
  HasVersioning: !Not [!Equals [!Ref VersioningStatus, '']]
  
  # Website conditions
  HasWebsiteIndexDocument: !Not [!Equals [!Ref WebsiteIndexDocument, '']]
  HasWebsiteErrorDocument: !Not [!Equals [!Ref WebsiteErrorDocument, '']]
  HasWebsiteRedirectAllRequestsTo: !Not [!Equals [!Ref WebsiteRedirectAllRequestsToHostName, '']]
  HasWebsiteRedirectProtocol: !Not [!Equals [!Ref WebsiteRedirectAllRequestsToProtocol, '']]
  HasWebsiteRoutingRules: !Not [!Equals [!Select [0, !Ref WebsiteRoutingRules], '']]
  HasWebsiteConfiguration: !Or
    - !Condition HasWebsiteIndexDocument
    - !Condition HasWebsiteRedirectAllRequestsTo

Resources:
  S3Bucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !If [HasBucketName, !Ref BucketName, !Ref 'AWS::NoValue']
      AccessControl: !If [HasAccessControl, !Ref AccessControl, 'Private']
      ObjectLockEnabled: !If [HasObjectLockEnabled, !Ref ObjectLockEnabled, 'false']
      Tags: !If [HasTags, !Split [',', !Join [',', !Ref Tags]], !Ref 'AWS::NoValue']
      
      # PublicAccessBlockConfiguration - set to true by default
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      
      # AccelerateConfiguration
      AccelerateConfiguration: !If
        - HasAccelerateConfiguration
        - AccelerationStatus: !Ref AccelerateConfigurationAccelerationStatus
        - !Ref 'AWS::NoValue'
      
      # AnalyticsConfigurations
      AnalyticsConfigurations: !If
        - HasAnalyticsConfiguration
        - - Id: !Ref AnalyticsConfigurationId
            Prefix: !If [HasAnalyticsConfigurationPrefix, !Ref AnalyticsConfigurationPrefix, '']
            TagFilters: !If 
              - HasAnalyticsConfigurationTagFilters
              - !Split [',', !Join [',', !Ref AnalyticsConfigurationTagFilters]]
              - []
        - !Ref 'AWS::NoValue'
      
      # BucketEncryption
      BucketEncryption: !If
        - HasBucketEncryption
        - ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: !Ref BucketEncryptionSSEAlgorithm
              KMSMasterKeyID: !If [HasBucketEncryptionKMSKey, !Ref BucketEncryptionKMSMasterKeyID, '']
            BucketKeyEnabled: !If [HasBucketKeyEnabled, !Ref BucketEncryptionBucketKeyEnabled, 'false']
        - !Ref 'AWS::NoValue'
      
      # CorsConfiguration
      CorsConfiguration: !If
        - HasCorsConfiguration
        - CorsRules:
          - AllowedHeaders: !If [HasCorsAllowedHeaders, !Ref CorsConfigurationAllowedHeaders, []]
            AllowedMethods: !If [HasCorsAllowedMethods, !Ref CorsConfigurationAllowedMethods, []]
            AllowedOrigins: !If [HasCorsAllowedOrigins, !Ref CorsConfigurationAllowedOrigins, []]
            ExposedHeaders: !If [HasCorsExposedHeaders, !Ref CorsConfigurationExposedHeaders, []]
            MaxAge: !If [HasCorsMaxAge, !Ref CorsConfigurationMaxAge, 0]
        - !Ref 'AWS::NoValue'
      
      # IntelligentTieringConfigurations
      IntelligentTieringConfigurations: !If
        - HasIntelligentTiering
        - - Id: !Ref IntelligentTieringId
            Status: !Ref IntelligentTieringStatus
            Prefix: !If [HasIntelligentTieringPrefix, !Ref IntelligentTieringPrefix, '']
            TagFilters: !If 
              - HasIntelligentTieringTagFilters
              - !Split [',', !Join [',', !Ref IntelligentTieringTagFilters]]
              - []
        - !Ref 'AWS::NoValue'
      
      # InventoryConfigurations
      InventoryConfigurations: !If
        - HasInventory
        - - Id: !Ref InventoryId
            Enabled: !Ref InventoryEnabled
            IncludedObjectVersions: !If [HasInventoryIncludedObjectVersions, !Ref InventoryIncludedObjectVersions, 'All']
            Schedule:
              Frequency: !If [HasInventoryScheduleFrequency, !Ref InventoryScheduleFrequency, 'Weekly']
            Destination:
              BucketArn: !If [HasInventoryDestinationBucketArn, !Ref InventoryDestinationBucketArn, '']
              Format: !If [HasInventoryDestinationFormat, !Ref InventoryDestinationFormat, 'CSV']
              Prefix: !If [HasInventoryPrefix, !Ref InventoryDestinationPrefix, '']
              OptionalFields: !If [HasInventoryOptionalFields, !Ref InventoryOptionalFields, '']
        - !Ref 'AWS::NoValue'
      
      # LifecycleConfiguration
      LifecycleConfiguration: !If
        - HasLifecycle
        - Rules:
          - Id: !Ref LifecycleRuleId
            Status: !Ref LifecycleRuleStatus
            Prefix: !If [HasLifecyclePrefix, !Ref LifecycleRulePrefix, '']
            TagFilters: !If 
              - HasLifecycleTagFilters
              - !Split [',', !Join [',', !Ref LifecycleRuleTagFilters]]
              - []
            ExpirationInDays: !If [HasLifecycleExpiration, !Ref LifecycleRuleExpirationDays, 0]
            NoncurrentVersionExpirationInDays: !If [HasLifecycleNoncurrentVersionExpiration, !Ref LifecycleRuleNoncurrentVersionExpirationDays, 0]
        - !Ref 'AWS::NoValue'
      
      # LoggingConfiguration
      LoggingConfiguration: !If
        - HasLogging
        - DestinationBucketName: !Ref LoggingDestinationBucketName
          LogFilePrefix: !If [HasLoggingPrefix, !Ref LoggingLogFilePrefix, '']
        - !Ref 'AWS::NoValue'
      
      # MetricsConfigurations
      MetricsConfigurations: !If
        - HasMetrics
        - - Id: !Ref MetricsId
            Prefix: !If [HasMetricsPrefix, !Ref MetricsPrefix, '']
            TagFilters: !If 
              - HasMetricsTagFilters
              - !Split [',', !Join [',', !Ref MetricsTagFilters]]
              - []
        - !Ref 'AWS::NoValue'
      
      # NotificationConfiguration
      NotificationConfiguration: !If
        - HasNotificationConfiguration
        - LambdaConfigurations: !If
            - HasLambdaNotification
            - - Event: !Ref NotificationLambdaEvent
                Function: !Ref NotificationLambdaFunction
                Filter: !If
                  - HasLambdaFilterPrefix
                  - S3Key:
                      Rules:
                        - Name: prefix
                          Value: !Ref NotificationLambdaFilterPrefix
                  - !If
                    - HasLambdaFilterSuffix
                    - S3Key:
                        Rules:
                          - Name: suffix
                            Value: !Ref NotificationLambdaFilterSuffix
                    - !Ref 'AWS::NoValue'
            - !Ref 'AWS::NoValue'
          QueueConfigurations: !If
            - HasQueueNotification
            - - Event: !Ref NotificationQueueEvent
                Queue: !Ref NotificationQueueQueue
                Filter: !If
                  - HasQueueFilterPrefix
                  - S3Key:
                      Rules:
                        - Name: prefix
                          Value: !Ref NotificationQueueFilterPrefix
                  - !If
                    - HasQueueFilterSuffix
                    - S3Key:
                        Rules:
                          - Name: suffix
                            Value: !Ref NotificationQueueFilterSuffix
                    - !Ref 'AWS::NoValue'
            - !Ref 'AWS::NoValue'
          TopicConfigurations: !If
            - HasTopicNotification
            - - Event: !Ref NotificationTopicEvent
                Topic: !Ref NotificationTopicTopic
                Filter: !If
                  - HasTopicFilterPrefix
                  - S3Key:
                      Rules:
                        - Name: prefix
                          Value: !Ref NotificationTopicFilterPrefix
                  - !If
                    - HasTopicFilterSuffix
                    - S3Key:
                        Rules:
                          - Name: suffix
                            Value: !Ref NotificationTopicFilterSuffix
                    - !Ref 'AWS::NoValue'
            - !Ref 'AWS::NoValue'
        - !Ref 'AWS::NoValue'
      
      # ObjectLockConfiguration
      ObjectLockConfiguration: !If
        - HasObjectLockConfiguration
        - ObjectLockEnabled: 'Enabled'
          Rule: !If
            - !Not [!Equals [!Ref ObjectLockDefaultRetentionMode, '']]
            - DefaultRetention:
                Mode: !Ref ObjectLockDefaultRetentionMode
                Days: !If [HasObjectLockRetentionDays, !Ref ObjectLockDefaultRetentionDays, 0]
                Years: !If [HasObjectLockRetentionYears, !Ref ObjectLockDefaultRetentionYears, 0]
            - !Ref 'AWS::NoValue'
        - !Ref 'AWS::NoValue'
      
      # OwnershipControls
      OwnershipControls: !If
        - HasOwnershipControls
        - Rules:
          - ObjectOwnership: !Ref OwnershipControlsRule
        - !Ref 'AWS::NoValue'
      
      # ReplicationConfiguration
      ReplicationConfiguration: !If
        - HasReplication
        - Role: !Ref ReplicationRole
          Rules:
            - Id: !Ref ReplicationRuleId
              Status: !Ref ReplicationRuleStatus
              Priority: !If [HasReplicationPriority, !Ref ReplicationRulePriority, 0]
              Prefix: !If [HasReplicationPrefix, !Ref ReplicationRulePrefix, '']
              Destination:
                Bucket: !Ref ReplicationRuleDestinationBucket
                StorageClass: !If [HasReplicationStorageClass, !Ref ReplicationRuleDestinationStorageClass, '']
        - !Ref 'AWS::NoValue'
      
      # VersioningConfiguration
      VersioningConfiguration: !If
        - HasVersioning
        - Status: !Ref VersioningStatus
        - !Ref 'AWS::NoValue'
      
      # WebsiteConfiguration
      WebsiteConfiguration: !If
        - HasWebsiteConfiguration
        - !If
          - HasWebsiteRedirectAllRequestsTo
          - RedirectAllRequestsTo:
              HostName: !Ref WebsiteRedirectAllRequestsToHostName
              Protocol: !If [HasWebsiteRedirectProtocol, !Ref WebsiteRedirectAllRequestsToProtocol, 'http']
          - !If
            - HasWebsiteIndexDocument
            - IndexDocument: !Ref WebsiteIndexDocument
              ErrorDocument: !If [HasWebsiteErrorDocument, !Ref WebsiteErrorDocument, '']
              RoutingRules: !If
                - HasWebsiteRoutingRules
                - !Split [',', !Join [',', !Ref WebsiteRoutingRules]]
                - []
            - !Ref 'AWS::NoValue'
        - !Ref 'AWS::NoValue'

Outputs:
  BucketName:
    Description: Name of the created S3 bucket
    Value: !Ref S3Bucket
    Export:
      Name: !Sub "\${AWS::StackName}-S3AccessLogsBucketName"
  
  BucketARN:
    Description: ARN of the created S3 bucket
    Value: !GetAtt S3Bucket.Arn
    Export:
      Name: !Sub "\${AWS::StackName}-S3AccessLogsBucketArn"
  
  BucketDomainName:
    Description: Domain name of the created S3 bucket
    Value: !GetAtt S3Bucket.DomainName
    Export:
      Name: !Sub "\${AWS::StackName}-S3AccessLogsBucketDomainName"
  
  BucketRegionalDomainName:
    Description: Regional domain name of the created S3 bucket
    Value: !GetAtt S3Bucket.RegionalDomainName
    Export:
      Name: !Sub "\${AWS::StackName}-S3AccessLogsBucketRegionalDomainName"
  
  BucketWebsiteURL:
    Description: Website URL of the created S3 bucket (if website configuration is enabled)
    Value: !GetAtt S3Bucket.WebsiteURL
    Condition: !Condition HasWebsiteConfiguration
    Export:
      Name: !Sub "\${AWS::StackName}-S3AccessLogsBucketWebsiteURL"
